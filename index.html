<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <title>Autocapture</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #0056b3;
      }

      #videoContainer {
        position: relative;
        width: 240px;
        height: 320px;
        background-color: black;
        margin-bottom: 20px;
        display: none;
      }

      video {
        width: 100%;
        height: 100%;
      }

      #photoGallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .photoContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      img {
        max-width: 200px;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      div {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        /* Abstand zwischen den Buttons */
      }

      button {
        width: 80%;
        height: 50px;
        /* Optionale Breitenanpassung */
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background-color: #0056b3;
      }

      select,
      #imageCount {
        margin: 10px 0;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
    </style>
  </head>

  <body>
    <h1>Autocapture</h1>
    <div id="videoContainer">
      <video id="video" autoplay playsinline></video>
    </div>
    <div>
      <label for="intervalSelect">Aufnahme-Intervall:</label>
      <select id="intervalSelect">
        <option value="1000">1 Sekunde</option>
        <option value="2000">2 Sekunden</option>
        <option value="5000">5 Sekunden</option>
        <option value="10000">10 Sekunden</option>
      </select>
      <button id="startCameraBtn">Kamera starten</button>
      <button id="stopCameraBtn" disabled>Kamera stoppen</button>
      <button id="showPhotosBtn">Fotos anzeigen</button>
      <button id="downloadAllBtn">Alle Fotos herunterladen</button>
      <button id="deletePhotosBtn">Alle Fotos löschen</button>
      <p id="storageInfo">Speicher: Wird geladen...</p>
      <p id="zipStatus">Status: Bereit</p>
    </div>
    <p id="imageCount">Gespeicherte Bilder: 0</p>
    <div id="photoGallery"></div>
    <script>
      let db;
      let stream;
      let photoInterval;
      let currentInterval = 250;

      function updateStorageInfo() {
        if (navigator.storage && navigator.storage.estimate) {
          navigator.storage.estimate().then((estimate) => {
            const usedMB = (estimate.usage / 1024 / 1024).toFixed(2); // In MB
            const totalMB = (estimate.quota / 1024 / 1024).toFixed(2); // In MB
            document.getElementById(
              "storageInfo"
            ).textContent = `Speicher: ${usedMB} MB von ${totalMB} MB verwendet`;
          });
        } else {
          document.getElementById("storageInfo").textContent =
            "Speicherinfo nicht verfügbar.";
        }
      }

      // IndexedDB initialisieren
      function initDatabase() {
        const request = indexedDB.open("PhotoApp", 1);
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains("photos")) {
            db.createObjectStore("photos", { keyPath: "id" });
          }
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          updateImageCount();
        };
        request.onerror = (event) => {
          console.error(
            "Fehler beim Initialisieren der Datenbank:",
            event.target.errorCode
          );
        };
      }

      async function startCamera() {
        try {
          if (!stream) {
            try {
              stream = await navigator.mediaDevices.getUserMedia({
                video: {
                  width: { ideal: 1080 }, // Breite im Hochformat (z. B. 720, 1080, 1440px)
                  height: { ideal: 1920 }, // Höhe im Hochformat (z. B. 1280, 1920, 2560px)
                  facingMode: "environment", // Rückkamera
                },
              });
              document.getElementById("video").srcObject = stream;
            } catch (error) {
              console.error("Fehler beim Zugriff auf die Kamera:", error);
            }
          }

          document.getElementById("video").srcObject = stream;
          document.getElementById("startCameraBtn").disabled = true;
          document.getElementById("stopCameraBtn").disabled = false;
          photoInterval = setInterval(takePhoto, currentInterval);
        } catch (error) {
          console.error("Fehler beim Zugriff auf die Kamera:", error);
        }
      }

      function stopCamera() {
        if (photoInterval) {
          clearInterval(photoInterval);
        }

        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        document.getElementById("startCameraBtn").disabled = false;
        document.getElementById("stopCameraBtn").disabled = true;
      }

      function takePhoto() {
        if (!stream) {
          console.error(
            "Stream ist nicht verfügbar. Starten Sie zuerst die Kamera."
          );
          return;
        }

        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);

        // Foto aufnehmen
        imageCapture
          .takePhoto()
          .then((blob) => {
            console.log("Foto aufgenommen");
            savePhotoToIndexedDB(blob); // Speichere das Bild in IndexedDB
            updateStorageInfo(); // Nach `initDatabase`, `savePhotoToIndexedDB` usw.
          })
          .catch((error) => {
            console.error("Fehler beim Aufnehmen des Fotos:", error);
          });
      }

      function savePhotoToIndexedDB(blob) {
        const reader = new FileReader();
        reader.onloadend = () => {
          const photoData = reader.result; // Base64-Daten des Bildes
          const transaction = db.transaction(["photos"], "readwrite");
          const store = transaction.objectStore("photos");
          store.add({ id: Date.now(), photoData });
          updateImageCount();
        };
        reader.readAsDataURL(blob); // Konvertiere Blob in Base64
      }

      function displayPhotos() {
        const gallery = document.getElementById("photoGallery");
        gallery.innerHTML = ""; // Galerie leeren

        const transaction = db.transaction(["photos"], "readonly");
        const store = transaction.objectStore("photos");
        const request = store.openCursor();
        let count = 0;

        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            const photo = cursor.value;

            const photoContainer = document.createElement("div");
            photoContainer.className = "photoContainer";

            const img = document.createElement("img");
            img.src = photo.photoData;

            const saveButton = document.createElement("button");
            saveButton.textContent = "Speichern";
            saveButton.onclick = () => savePhoto(photo.photoData);

            photoContainer.appendChild(img);
            photoContainer.appendChild(saveButton);
            gallery.appendChild(photoContainer);

            count++;
            if (count < 50) {
              cursor.continue(); // Nächste Fotos abrufen
            } else {
              console.log(
                "Batch komplett. Weitere Fotos mit erneutem Aufruf laden."
              );
            }
          }
        };

        request.onerror = () => {
          console.error("Fehler beim Abrufen der Fotos:", request.error);
        };
      }

      // Funktion: Foto als Datei speichern
      function savePhoto(photoData) {
        const a = document.createElement("a");
        a.href = photoData; // Base64-URL des Fotos
        a.download = `photo_${Date.now()}.jpg`; // Standard-Dateiname
        a.click();
      }

      function deleteAllPhotos() {
        if (confirm("Möchten Sie wirklich alle Fotos löschen?")) {
          if (db) {
            // Schließe alle laufenden Transaktionen und die Verbindung
            const transaction = db.transaction(["photos"], "readwrite");

            transaction.oncomplete = () => {
              console.log(
                "Alle Transaktionen abgeschlossen. Schließe die Datenbank."
              );
              db.close();
              db = null;

              // Starte den Löschvorgang der Datenbank
              const request = indexedDB.deleteDatabase("PhotoApp");

              request.onsuccess = () => {
                console.log("Datenbank erfolgreich gelöscht.");
                initDatabase(); // Datenbank neu initialisieren
                updateImageCount(); // Zähler aktualisieren
                updateStorageInfo(); // Speicherinfo aktualisieren
                alert(
                  "Alle Fotos wurden erfolgreich gelöscht und der Speicher wurde freigegeben."
                );
              };

              request.onerror = (event) => {
                console.error(
                  "Fehler beim Löschen der Datenbank:",
                  event.target.error
                );
                alert("Fehler beim Löschen der Fotos.");
              };

              request.onblocked = () => {
                console.warn(
                  "Datenbank konnte nicht gelöscht werden, da sie noch verwendet wird."
                );
                alert(
                  "Die Datenbank konnte nicht gelöscht werden, da sie noch verwendet wird. Die Seite wird jetzt neu geladen, um den Vorgang abzuschließen."
                );
                setTimeout(() => location.reload(), 2000); // Reload nach 2 Sekunden
              };
            };

            transaction.onerror = (event) => {
              console.error(
                "Fehler beim Beenden von Transaktionen:",
                event.target.error
              );
              alert(
                "Fehler beim Beenden der Datenbankverbindung. Die Fotos wurden möglicherweise nicht gelöscht."
              );
            };
          } else {
            // Falls die Datenbank bereits geschlossen ist, starte direkt den Löschvorgang
            const request = indexedDB.deleteDatabase("PhotoApp");

            request.onsuccess = () => {
              console.log("Datenbank erfolgreich gelöscht.");
              initDatabase();
              updateImageCount();
              updateStorageInfo();
              alert(
                "Alle Fotos wurden erfolgreich gelöscht und der Speicher wurde freigegeben."
              );
            };

            request.onerror = (event) => {
              console.error(
                "Fehler beim Löschen der Datenbank:",
                event.target.error
              );
              alert("Fehler beim Löschen der Fotos.");
            };

            request.onblocked = () => {
              console.warn(
                "Datenbank konnte nicht gelöscht werden, da sie noch verwendet wird."
              );
              alert(
                "Die Datenbank konnte nicht gelöscht werden, da sie noch verwendet wird. Die Seite wird jetzt neu geladen, um den Vorgang abzuschließen."
              );
              setTimeout(() => location.reload(), 2000);
            };
          }
        }
      }

      function updateImageCount() {
        const transaction = db.transaction(["photos"], "readonly");
        const store = transaction.objectStore("photos");
        const request = store.count();
        request.onsuccess = () => {
          document.getElementById(
            "imageCount"
          ).textContent = `Gespeicherte Bilder: ${request.result}`;
        };
      }

      async function downloadAllPhotos() {
        const zip = new JSZip();
        const transaction = db.transaction(["photos"], "readonly");
        const store = transaction.objectStore("photos");
        const request = store.openCursor(); // Cursor verwenden

        const statusElement = document.getElementById("zipStatus");
        statusElement.textContent = "Status: Lade Fotos aus der Datenbank...";

        let processed = 0;
        let totalPhotos = 0;

        // Zähle die Einträge
        const countRequest = store.count();
        countRequest.onsuccess = () => {
          totalPhotos = countRequest.result; // Gesamtanzahl der Fotos
        };

        request.onsuccess = async (event) => {
          const cursor = event.target.result;
          if (cursor) {
            const photo = cursor.value;
            const base64Data = photo.photoData.split(",")[1]; // Entfernt den Data-URL-Header
            zip.file(`photo_${photo.id}.jpg`, base64Data, { base64: true });

            processed++;
            statusElement.textContent = `Status: Fotos zippen... (${processed}/${totalPhotos})`;

            cursor.continue(); // Nächstes Foto laden
          } else {
            // Alle Fotos verarbeitet, jetzt ZIP generieren
            statusElement.textContent = "Status: Erstelle ZIP-Datei...";
            zip
              .generateAsync({ type: "blob" }, (metadata) => {
                const progress =
                  Math.round((metadata.percent || 0) * 100) / 100;
                statusElement.textContent = `Status: ZIP-Erstellung... ${progress}%`;
              })
              .then((content) => {
                const a = document.createElement("a");
                const url = URL.createObjectURL(content);

                // Dateiname mit Zeitstempel
                const now = new Date();
                const date = now
                  .toLocaleDateString("de-DE")
                  .replace(/\./g, "-");
                const time = now.toLocaleTimeString("de-DE").replace(/:/g, "-");
                const timestamp = `${date}_${time}`;
                a.download = `photos_${timestamp}.zip`;

                a.href = url;
                a.click();
                URL.revokeObjectURL(url);
                statusElement.textContent = "Status: Download abgeschlossen.";
              })
              .catch((error) => {
                console.error("Fehler beim Erstellen der ZIP-Datei:", error);
                statusElement.textContent =
                  "Status: Fehler beim Erstellen der ZIP-Datei.";
              });
          }
        };

        request.onerror = () => {
          console.error("Fehler beim Abrufen der Fotos:", request.error);
          statusElement.textContent = "Status: Fehler beim Abrufen der Fotos.";
        };
      }

      document
        .getElementById("downloadAllBtn")
        .addEventListener("click", downloadAllPhotos);
      document
        .getElementById("startCameraBtn")
        .addEventListener("click", startCamera);
      document
        .getElementById("stopCameraBtn")
        .addEventListener("click", stopCamera);
      document
        .getElementById("showPhotosBtn")
        .addEventListener("click", displayPhotos);
      document
        .getElementById("deletePhotosBtn")
        .addEventListener("click", deleteAllPhotos);
      document
        .getElementById("intervalSelect")
        .addEventListener("change", (event) => {
          currentInterval = parseInt(event.target.value, 10);
          if (photoInterval) {
            clearInterval(photoInterval);
            photoInterval = setInterval(takePhoto, currentInterval);
          }
        });
      initDatabase();
      updateStorageInfo(); // Nach `initDatabase`, `savePhotoToIndexedDB` usw.
      startCamera();
    </script>
  </body>
</html>
